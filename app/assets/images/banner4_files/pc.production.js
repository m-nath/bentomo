Namespace('jp.mixi.news.ui.pc.checkwindow')
.define(function(ns){'use strict';var openCheckWindow=function(shareUrl){window.open(shareUrl,'share',['width=632','height=456','location=yes','resizable=yes','toolbar=no','menubar=no','scrollbars=no','status=no'].join(','));};ns.provide({openCheckWindow:openCheckWindow});});Namespace('jp.mixi.news.ui.photogroup.navigator')
.use('brook.channel sendChannel')
.use('flipsnap Flipsnap')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.ui.template getTemplateByElementId')
.define(function(ns){'use strict';var SELECT_THUMBNAIL_CHANNEL=ns.CURRENT_NAMESPACE+'.selectThumbnail';var PhotoGroupNavigator=ns.defineClass({moveToIndex:function(index){this.flipsnap.moveToPoint(this.getPageFromIndex(index));this.selectThumbnail(index);},initialize:function(element,data){this.jRoot=$j(element);this.jNavContainer=this.jRoot.find(data.navContainerSelector);this.jNavPhotoList=this.jRoot.find(data.navPhotoListSelector);this.jNavNextButton=this.jRoot.find(data.navNextButtonSelector);this.jNavPrevButton=this.jRoot.find(data.navPrevButtonSelector);this.thumbnailSelector=data.thumbnailSelector;this.entryList=ns.gateway('news_entry_list');this.classForSelected=data.classForSelected;this.flipsnap=undefined;this.currentPosition=0;this.thumbnailsPerPage=0;this.assignPhotoList();this.initFlipsnap();this.updateUI();var self=this;this.jNavNextButton.click(function(){self.onNextButtonClick();});this.jNavPrevButton.click(function(){self.onPrevButtonClick();});this.jNavPhotoList.find('a').click(function(e){self.onThumbnailButtonClick(e);});},assignPhotoList:function(){var template=ns.getTemplateByElementId('photo_group_thumbnail_row');template.param({news_entry_list:this.entryList});var html=template.output();this.jNavPhotoList.html(html);},initFlipsnap:function(){this.currentPosition=0;var navigatorWidth=this.jNavContainer.width();var thumbnailWidth=this.jNavPhotoList.children().last().outerWidth({margin:true});this.thumbnailsPerPage=Math.floor(navigatorWidth/thumbnailWidth);this.flipsnap=ns.Flipsnap(this.jNavPhotoList.get(0),{distance:thumbnailWidth*this.thumbnailsPerPage,maxPoint:Math.ceil(this.entryList.length/this.thumbnailsPerPage)-1});this.jNavPhotoList.width(thumbnailWidth*this.entryList.length);var self=this;$j(this.flipsnap.element).on('fsmoveend',function(){self.currentPosition=self.flipsnap.currentPoint;self.updateUI();});},onNextButtonClick:function(){this.flipsnap.toNext();},onPrevButtonClick:function(){this.flipsnap.toPrev();},onThumbnailButtonClick:function(event){var target=this.jRoot.find(event.currentTarget).closest(this.thumbnailSelector);var index=this.jNavPhotoList.children().index(target);this.selectThumbnail(index);ns.sendChannel(SELECT_THUMBNAIL_CHANNEL).run({index:index});},updateUI:function(){var entry=this.entryList[this.currentPosition];this.setVisibility(this.jNavNextButton,this.flipsnap.hasNext());this.setVisibility(this.jNavPrevButton,this.flipsnap.hasPrev());},selectThumbnail:function(index){this.jNavPhotoList.children().removeClass(this.classForSelected);this.jNavPhotoList.children().eq(index).addClass(this.classForSelected);this.flipsnap.moveToPoint(this.getPageFromIndex(index));},setVisibility:function(jElement,isVisible){if(isVisible){jElement.show();}else{jElement.hide();}},getPageFromIndex:function(index){return Math.floor(index/this.thumbnailsPerPage);}});ns.provide({PhotoGroupNavigator:function(element,data){return new PhotoGroupNavigator(element,data);}});});Namespace('jp.mixi.news.widget.emoji.button.pc')
.use('jp.co.mixi.emojiPaletteLoader EmojiPaletteLoader')
.use('jp.co.mixi.lang.class defineClass')
.define(function(ns){'use strict';var EMOJI_ICON_HALF_HEIGHT=11;var EmojiButton=ns.defineClass({initialize:function(element,data){var self=this;self.jTextAreaElement=$j(data.textAreaElementId);self.emojiPaletteLoader=ns.EmojiPaletteLoader();self.emojiPaletteLoader.loadEmojiPalette();$j(element).click(function(event){self.clickEvent(event);});},clickEvent:function(event){var self=this;event.preventDefault();event.stopPropagation();window.openEmojiPalette(self.jTextAreaElement.get(0),event);var emojiPaletteBase=self.emojiPaletteLoader.getEmojiPaletteBase();var emojiPaletteOffset=emojiPaletteBase.getDimensions();$j(emojiPaletteBase).css({'top':(emojiPaletteBase.offsetTop-emojiPaletteOffset.height-EMOJI_ICON_HALF_HEIGHT)+'px'});}});ns.provide({registerElement:function(element,data){new EmojiButton(element,data);}});});Namespace('jp.mixi.news.widget.check.button.pc')
.use('jp.mixi.news.ui.pc.checkwindow openCheckWindow')
.define(function(ns){'use strict';ns.provide({registerElement:function(element,data){$j(element).click(function(){ns.openCheckWindow(data.shareUrl);});}});});Namespace('jp.mixi.news.widget.photogroup.view')
.use('brook.channel channel')
.use('brook.util through')
.use('jp.co.mixi.gateway gateway')
.use('jp.mixi.news.ui.photogroup.view PhotoGroupViewer')
.use('jp.mixi.news.ui.photogroup.navigator PhotoGroupNavigator')
.use('jp.mixi.news.ui.pc.checkwindow openCheckWindow')
.define(function(ns){'use strict';var CHECK_SERVICE_KEY='53be64390c2bf14912cc8ded09c28d346a7a28b0';var VIEWER_SET_NEWS_CHANNEL='jp.mixi.news.ui.photogroup.view.setNews';var NAVIGATOR_SELECT_THUMBNAIL_CHANNEL='jp.mixi.news.ui.photogroup.navigator.selectThumbnail';var photoGroupViewer=function(element,data){var jRoot=$j(element);var jTotalSharedCount=jRoot.find(data.totalSharedCountSelector);var jPrivateQuoteCount=jRoot.find(data.privateQuoteCountSelector);var jPrivateQuoteContainer=jRoot.find(data.privateQuoteContainerSelector);var jCheckButton=jRoot.find(data.checkButtonSelector);var jQuoteDescription=jRoot.find(data.quoteDescriptionSelector);var jAddDiaryLink=jRoot.find(data.addDiaryLinkSelector);var jRelationalPost=jRoot.find(data.relationalPostSelector);var jQuoteVoiceArea=jRoot.find(data.quoteVoiceAreaSelector);var jQuoteVoiceCount=jRoot.find(data.quoteVoiceCountSelector);var jQuoteVoiceLink=jRoot.find(data.quoteVoiceLinkSelector);var jQuoteVoiceCountContainer=jRoot.find(data.quoteVoiceCountContainerSelector);var jQuoteVoiceAuthor=jRoot.find(data.quoteVoiceAuthorSelector);var jQuoteVoiceBody=jRoot.find(data.quoteVoiceBodySelector);var jQuoteVoiceFeedbackCount=jRoot.find(data.quoteVoiceFeedbackCountSelector);var jQuoteVoiceCommentCount=jRoot.find(data.quoteVoiceCommentCountSelector);var jQuoteVoiceCommentLink=jRoot.find(data.quoteVoiceCommentLinkSelector);var jQuoteDiaryArea=jRoot.find(data.quoteDiaryAreaSelector);var jQuoteDiaryCount=jRoot.find(data.quoteDiaryCountSelector);var jQuoteDiaryLink=jRoot.find(data.quoteDiaryLinkSelector);var jQuoteDiaryCountContainer=jRoot.find(data.quoteDiaryCountContainerSelector);var jQuoteDiaryAuthor=jRoot.find(data.quoteDiaryAuthorSelector);var jQuoteDiaryTitle=jRoot.find(data.quoteDiaryTitleSelector);var jQuoteDiaryBody=jRoot.find(data.quoteDiaryBodySelector);var jQuoteDiaryViewLink=jRoot.find(data.quoteDiaryViewLinkSelector);var loginMemberId=ns.gateway('login_member_id');var mixiPrefixSSL=ns.gateway('url_mixi_prefix_ssl');var mixiNewsPrefixSSL=ns.gateway('url_news_prefix_ssl');var photoGroupViewer;var navigator;var initialize=function(){ns.channel(VIEWER_SET_NEWS_CHANNEL).observe(setNewsPromise);ns.channel(NAVIGATOR_SELECT_THUMBNAIL_CHANNEL).observe(onThumbnailSelectPromise);navigator=ns.PhotoGroupNavigator(element,data);photoGroupViewer=ns.PhotoGroupViewer(element,data);jCheckButton.click(onClickCheckButton);};var onClickCheckButton=function(){var shareUrl=mixiPrefixSSL+'share.pl?k='+CHECK_SERVICE_KEY+'&u='+encodeURIComponent(photoGroupViewer.shareInfoForCurrentPosition.url.newsUrl);ns.openCheckWindow(shareUrl);};var setNewsPromise=ns.through(function(value){var entry=value.entry;var index=value.index;var quoteVoiceLink=mixiNewsPrefixSSL+'list_quote.pl?sort=feedback_count&type=voice&news_id='+entry.news_id;var quoteDiaryLink=mixiNewsPrefixSSL+'list_quote.pl?sort=feedback_count&type=diary&news_id='+entry.news_id;var addDiaryLink=mixiPrefixSSL+
'add_diary.pl?id='+loginMemberId+
'&news_id='+entry.news_id+
'&diary_body='+entry.quote_diary_info.body+
'&news_title='+entry.quote_diary_info.title+
'&news_url='+entry.quote_diary_info.news_url+
'&via=photogroup';jTotalSharedCount.text(entry.total_shared_count);jQuoteVoiceCount.text(entry.quote_voice_count);jQuoteDiaryCount.text(entry.quote_diary_count);var privateCount=entry.total_shared_count-entry.quote_voice_count-entry.quote_diary_count;jPrivateQuoteCount.text(privateCount);setVisibility(jPrivateQuoteContainer,privateCount>0);jQuoteVoiceLink.attr('href',quoteVoiceLink);setVisibility(jQuoteVoiceCountContainer,entry.quote_voice_count>0);jQuoteDiaryLink.attr('href',quoteDiaryLink);setVisibility(jQuoteDiaryCountContainer,entry.quote_diary_count>0);jAddDiaryLink.attr('href',addDiaryLink);setVisibility(jRelationalPost,loginMemberId||entry.quote_voice_count||entry.quote_diary_count);setQuoteVoice(entry);setQuoteDiary(entry);if(navigator){navigator.moveToIndex(index);}});var onThumbnailSelectPromise=ns.through(function(value){setTimeout(function(){photoGroupViewer.moveToPoint(value.index);},100);});var setQuoteVoice=function(entry){var voice=entry.voice;if(!voice){jQuoteVoiceArea.hide();return;}
jQuoteVoiceBody.html(voice.body_with_emoji_view_html);var voiceThumbnail=$j('<img>')
.attr('src',voice.member_thumbnail_url)
.attr('alt',voice.member_nickname);jQuoteVoiceAuthor
.html('')
.append(voiceThumbnail)
.append(voice.member_nickname)
.attr('href',voice.url_show_friend);jQuoteVoiceFeedbackCount.text(voice.feedback_count);jQuoteVoiceCommentCount.text(voice.comment_count);jQuoteVoiceCommentLink.attr('href',voice.url_view_voice);jQuoteVoiceArea.show();};var setQuoteDiary=function(entry){var diary=entry.diary;if(!diary){jQuoteDiaryArea.hide();return;}
jQuoteDiaryTitle.text(diary.title);jQuoteDiaryBody.html(diary.body_with_emoji_view_html);var diaryThumbnail=$j('<img>')
.attr('src',diary.member_thumbnail_url)
.attr('alt',diary.member_nickname);jQuoteDiaryAuthor
.html('')
.append(diaryThumbnail)
.append(diary.member_nickname)
.attr('href',diary.url_show_friend);jQuoteDiaryViewLink.attr('href',diary.url_view_diary);jQuoteDiaryArea.show();};var setVisibility=function(jElement,isVisible){if(isVisible){jElement.show();}else{jElement.hide();}};initialize();};ns.provide({registerElement:photoGroupViewer});});Namespace('jp.mixi.service.analysis')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.lang parseIntAsDecimal')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.use('jp.co.mixi.logging Log')
.use('jp.mixi.analysis.google_analytics sendEvent')
.define(function(ns){var memberId=ns.parseIntAsDecimal(ns.gateway('login_member_id'));var postKey=ns.gateway('rpc_post_key');var SAMPLING_ID=68;var isSamplingId=((memberId%100)===SAMPLING_ID);var rpc=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:postKey});var isDebug=ns.gateway('RUN_MODE')=='debug';var isStaging=ns.gateway('RUN_MODE')=='staging';var DEFAULT_ACTION="click";ns.provide({postAnalysisLog:function(locationParam){if(!locationParam){return;}
if(!isSamplingId&&!isDebug){return;}
rpc.call('jp.mixi.analysis.analysisOfClickCount',{member_id:memberId,location:locationParam},function(){});},postUIEventLog:function(eventName,pageName,callback,errorCallback){if(!eventName){return;}
rpc.call('jp.mixi.analysis.uievent.send',{member_id:memberId,event_name:eventName,page_name:pageName},(callback||function(){}),(errorCallback||function(){}));},postUIEventLogToGA:function(trackerName,params){if(!trackerName){ns.Log.warn('trackerName is required');return;}
if(!params.eventCategory){ns.Log.warn('eventCategory is required');return;}
if(!params.eventAction){params.eventAction=DEFAULT_ACTION;}
ns.sendEvent(trackerName,params);},isSamplingIdOnePercent:function(samplingId){var isSampling=((memberId%100)===samplingId);if(!isSampling&&!isDebug&&!isStaging){return;}
return true;},isSamplingIdTenPercent:function(samplingId){var isSampling=((memberId%10)===samplingId);if(!isSampling&&!isDebug&&!isStaging){return;}
return true;},postWidgetProfilerLog:function(logAggregate,totalCount,totalTime,pathname){if(!logAggregate||!totalCount||!totalTime||!pathname){return;}
rpc.call('jp.mixi.analysis.behaviour.sendMessage',{name:"widget.profiler",value:{logAgregate:logAggregate,totalCount:totalCount,totalTime:totalTime,pathname:pathname}},function(){});}});});Namespace('jp.mixi.common.widget.pc.holdposition')
.define(function(ns){'use strict';var userAgent=window.navigator.userAgent.toLowerCase();if(userAgent.match(/ipad|iphone|android/)){return;}
if(userAgent.indexOf('mac')!==-1&&userAgent.indexOf('safari')!==-1&&userAgent.indexOf('chrome')===-1){return;}
var DEFAULT_PADDING_TOP=5;var isStartedListenScrollEvent=false;var $selfColumnElement;var $pairColumnElement;var selfColumnLeft;var $window=$j(window);var startListenScrollEvent=function(target){if(isStartedListenScrollEvent)return;$window.on('scroll',function(e){reposition(target);});$window.on('resize',function(e){resetColumLeftHorizontalPosition(target,5);});reposition(target);isStartedListenScrollEvent=true;};function resetColumLeftHorizontalPosition(target,counter){if(counter<=0){return;}
selfColumnLeft=$selfColumnElement.offset().left;reposition(target);setTimeout(function(){resetColumLeftHorizontalPosition(target,counter-1);},1000);}
function reposition(target){var pairColumnHeight=$pairColumnElement.height();var targetHeight=target.element.prop('scrollHeight');var selfColumnHeight=$selfColumnElement.height();if(pairColumnHeight<selfColumnHeight)return;var $element=target.element;var scrollTop=$window.scrollTop();var scrollLeft=$window.scrollLeft();var paddingTop=parseInt(target.dataset.paddingTop,10)||DEFAULT_PADDING_TOP;var pairColumnRect=$pairColumnElement[0].getBoundingClientRect();if((target.top-paddingTop<scrollTop)&&pairColumnHeight+pairColumnRect.top>=targetHeight){if($element.css('position')==='fixed'){selfColumnHeight=$selfColumnElement.height()+targetHeight;}
$element.css('position','fixed');$element.css('top',paddingTop+'px');var overLeft=selfColumnLeft-scrollLeft;$element.css('left',overLeft+'px');}
else if(target.top+paddingTop>scrollTop&&$element.css('position')==='fixed'){$element.css('position','');$element.css('top','');}
else if((pairColumnHeight+pairColumnRect.top<targetHeight)&&$element.css('position')!=='relative'){var overHeight=pairColumnHeight-selfColumnHeight-paddingTop-targetHeight;$element.css('position','relative');$element.css('top',overHeight+'px');$element.css('left','auto');}}
var holdElement=function(element,dataset){$selfColumnElement=$j(dataset.selfColumnSelector);$pairColumnElement=$j(dataset.pairColumnSelector);selfColumnLeft=$selfColumnElement.offset().left;var $element=$j(element);var appVersion=window.navigator.appVersion.toLowerCase();if((appVersion.indexOf('msie 7.')!==-1)||(appVersion.indexOf('msie 8.')!==-1)){$element.css('zoom',1);}
$window.load(function(){var targetData={top:$element.offset().top,element:$element,dataset:dataset};startListenScrollEvent(targetData);});};ns.provide({registerElement:holdElement});});Namespace('jp.co.mixi.widget.openwindow')
.define(function(ns){'use strict';ns.provide({registerElement:function(element,dataset){if(!dataset.url)throw new Error('data-url required');if(!dataset.windowName)throw new Error('data-window-name required');$j(element).on('click',function(){window.open(dataset.url,dataset.windowName,dataset.features||'');return false;});}});});Namespace('jp.co.mixi.gateway')
.define(function(ns){ns.provide({gateway:function(name){return window.Mixi?Mixi.Gateway.getParam(name):undefined;},getAllGatewayData:function(){return window.Mixi?Mixi.Gateway.getParam():undefined;}});});