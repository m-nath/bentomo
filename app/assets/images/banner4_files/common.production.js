Namespace('flipsnap')
.define(function(ns){(function(window,document,undefined){var div=document.createElement('div');var prefix=['webkit','moz','o','ms'];var saveProp={};var support=Flipsnap.support={};var gestureStart=false;var DISTANCE_THRESHOLD=5;var ANGLE_THREHOLD=55;support.transform3d=hasProp(['perspectiveProperty','WebkitPerspective','MozPerspective','OPerspective','msPerspective']);support.transform=hasProp(['transformProperty','WebkitTransform','MozTransform','OTransform','msTransform']);support.transition=hasProp(['transitionProperty','WebkitTransitionProperty','MozTransitionProperty','OTransitionProperty','msTransitionProperty']);support.addEventListener='addEventListener'in window;support.mspointer=window.navigator.msPointerEnabled;support.cssAnimation=(support.transform3d||support.transform)&&support.transition;var eventTypes=['touch','mouse'];var events={start:{touch:'touchstart',mouse:'mousedown'},move:{touch:'touchmove',mouse:'mousemove'},end:{touch:'touchend',mouse:'mouseup'}};if(support.addEventListener){document.addEventListener('gesturestart',function(){gestureStart=true;});document.addEventListener('gestureend',function(){gestureStart=false;});}
function Flipsnap(element,opts){return(this instanceof Flipsnap)?this.init(element,opts):new Flipsnap(element,opts);}
Flipsnap.prototype.init=function(element,opts){var self=this;self.element=element;if(typeof element==='string'){self.element=document.querySelector(element);}
if(!self.element){throw new Error('element not found');}
if(support.mspointer){self.element.style.msTouchAction='pan-y';}
opts=opts||{};self.distance=opts.distance;self.maxPoint=opts.maxPoint;self.disableTouch=(opts.disableTouch===undefined)?false:opts.disableTouch;self.disable3d=(opts.disable3d===undefined)?false:opts.disable3d;self.transitionDuration=(opts.transitionDuration===undefined)?'350ms':opts.transitionDuration+'ms';self.currentPoint=0;self.currentX=0;self.animation=false;self.use3d=support.transform3d;if(self.disable3d===true){self.use3d=false;}
if(support.cssAnimation){self._setStyle({transitionProperty:getCSSVal('transform'),transitionTimingFunction:'cubic-bezier(0,0,0.25,1)',transitionDuration:'0ms',transform:self._getTranslate(0)});}
else{self._setStyle({position:'relative',left:'0px'});}
self.refresh();eventTypes.forEach(function(type){self.element.addEventListener(events.start[type],self,false);});return self;};Flipsnap.prototype.handleEvent=function(event){var self=this;switch(event.type){case events.start.touch:self._touchStart(event,'touch');break;case events.start.mouse:self._touchStart(event,'mouse');break;case events.move.touch:self._touchMove(event,'touch');break;case events.move.mouse:self._touchMove(event,'mouse');break;case events.end.touch:self._touchEnd(event,'touch');break;case events.end.mouse:self._touchEnd(event,'mouse');break;case'click':self._click(event);break;}};Flipsnap.prototype.refresh=function(){var self=this;self._maxPoint=(self.maxPoint===undefined)?(function(){var childNodes=self.element.childNodes,itemLength=-1,i=0,len=childNodes.length,node;for(;i<len;i++){node=childNodes[i];if(node.nodeType===1){itemLength++;}}
return itemLength;})():self.maxPoint;if(self.distance===undefined){if(self._maxPoint<0){self._distance=0;}
else{self._distance=self.element.scrollWidth/(self._maxPoint+1);}}
else{self._distance=self.distance;}
self._maxX=-self._distance*self._maxPoint;self.moveToPoint();};Flipsnap.prototype.hasNext=function(){var self=this;return self.currentPoint<self._maxPoint;};Flipsnap.prototype.hasPrev=function(){var self=this;return self.currentPoint>0;};Flipsnap.prototype.toNext=function(transitionDuration){var self=this;if(!self.hasNext()){return;}
self.moveToPoint(self.currentPoint+1,transitionDuration);};Flipsnap.prototype.toPrev=function(transitionDuration){var self=this;if(!self.hasPrev()){return;}
self.moveToPoint(self.currentPoint-1,transitionDuration);};Flipsnap.prototype.moveToPoint=function(point,transitionDuration){var self=this;transitionDuration=transitionDuration===undefined?self.transitionDuration:transitionDuration+'ms';var beforePoint=self.currentPoint;if(point===undefined){point=self.currentPoint;}
if(point<0){self.currentPoint=0;}
else if(point>self._maxPoint){self.currentPoint=self._maxPoint;}
else{self.currentPoint=parseInt(point,10);}
if(support.cssAnimation){self._setStyle({transitionDuration:transitionDuration});}
else{self.animation=true;}
self._setX(-self.currentPoint*self._distance,transitionDuration);if(beforePoint!==self.currentPoint){self._triggerEvent('fsmoveend',true,false);self._triggerEvent('fspointmove',true,false);}};Flipsnap.prototype._setX=function(x,transitionDuration){var self=this;self.currentX=x;if(support.cssAnimation){self.element.style[saveProp.transform]=self._getTranslate(x);}
else{if(self.animation){self._animate(x,transitionDuration||self.transitionDuration);}
else{self.element.style.left=x+'px';}}};Flipsnap.prototype._touchStart=function(event,type){var self=this;if(self.disableTouch||self.scrolling||gestureStart){return;}
self.element.addEventListener(events.move[type],self,false);document.addEventListener(events.end[type],self,false);var tagName=event.target.tagName;if(type==='mouse'&&tagName!=='SELECT'&&tagName!=='INPUT'&&tagName!=='TEXTAREA'&&tagName!=='BUTTON'){event.preventDefault();}
if(support.cssAnimation){self._setStyle({transitionDuration:'0ms'});}
else{self.animation=false;}
self.scrolling=true;self.moveReady=false;self.startPageX=getPage(event,'pageX');self.startPageY=getPage(event,'pageY');self.basePageX=self.startPageX;self.directionX=0;self.startTime=event.timeStamp;self._triggerEvent('fstouchstart',true,false);};Flipsnap.prototype._touchMove=function(event,type){var self=this;if(!self.scrolling||gestureStart){return;}
var pageX=getPage(event,'pageX');var pageY=getPage(event,'pageY');var distX;var newX;if(self.moveReady){event.preventDefault();distX=pageX-self.basePageX;newX=self.currentX+distX;if(newX>=0||newX<self._maxX){newX=Math.round(self.currentX+distX/3);}
self.directionX=distX===0?self.directionX:distX>0?-1:1;var isPrevent=!self._triggerEvent('fstouchmove',true,true,{delta:distX,direction:self.directionX});if(isPrevent){self._touchAfter({moved:false,originalPoint:self.currentPoint,newPoint:self.currentPoint,cancelled:true});}else{self._setX(newX);}}
else{var triangle=getTriangleSide(self.startPageX,self.startPageY,pageX,pageY);if(triangle.z>DISTANCE_THRESHOLD){if(getAngle(triangle)>ANGLE_THREHOLD){event.preventDefault();self.moveReady=true;self.element.addEventListener('click',self,true);}
else{self.scrolling=false;}}}
self.basePageX=pageX;};Flipsnap.prototype._touchEnd=function(event,type){var self=this;self.element.removeEventListener(events.move[type],self,false);document.removeEventListener(events.end[type],self,false);if(!self.scrolling){return;}
var newPoint=-self.currentX/self._distance;newPoint=(self.directionX>0)?Math.ceil(newPoint):(self.directionX<0)?Math.floor(newPoint):Math.round(newPoint);if(newPoint<0){newPoint=0;}
else if(newPoint>self._maxPoint){newPoint=self._maxPoint;}
self._touchAfter({moved:newPoint!==self.currentPoint,originalPoint:self.currentPoint,newPoint:newPoint,cancelled:false});self.moveToPoint(newPoint);};Flipsnap.prototype._click=function(event){var self=this;event.stopPropagation();event.preventDefault();};Flipsnap.prototype._touchAfter=function(params){var self=this;self.scrolling=false;self.moveReady=false;setTimeout(function(){self.element.removeEventListener('click',self,true);},200);self._triggerEvent('fstouchend',true,false,params);};Flipsnap.prototype._setStyle=function(styles){var self=this;var style=self.element.style;for(var prop in styles){setStyle(style,prop,styles[prop]);}};Flipsnap.prototype._animate=function(x,transitionDuration){var self=this;var elem=self.element;var begin=+new Date();var from=parseInt(elem.style.left,10);var to=x;var duration=parseInt(transitionDuration,10);var easing=function(time,duration){return-(time/=duration)*(time-2);};var timer=setInterval(function(){var time=new Date()-begin;var pos,now;if(time>duration){clearInterval(timer);now=to;}
else{pos=easing(time,duration);now=pos*(to-from)+from;}
elem.style.left=now+"px";},10);};Flipsnap.prototype.destroy=function(){var self=this;eventTypes.forEach(function(type){self.element.removeEventListener(events.start[type],self,false);});};Flipsnap.prototype._getTranslate=function(x){var self=this;return self.use3d?'translate3d('+x+'px, 0, 0)':'translate('+x+'px, 0)';};Flipsnap.prototype._triggerEvent=function(type,bubbles,cancelable,data){var self=this;var ev=document.createEvent('Event');ev.initEvent(type,bubbles,cancelable);if(data){for(var d in data){if(data.hasOwnProperty(d)){ev[d]=data[d];}}}
return self.element.dispatchEvent(ev);};function getPage(event,page){return event.changedTouches?event.changedTouches[0][page]:event[page];}
function hasProp(props){return some(props,function(prop){return div.style[prop]!==undefined;});}
function setStyle(style,prop,val){var _saveProp=saveProp[prop];if(_saveProp){style[_saveProp]=val;}
else if(style[prop]!==undefined){saveProp[prop]=prop;style[prop]=val;}
else{some(prefix,function(_prefix){var _prop=ucFirst(_prefix)+ucFirst(prop);if(style[_prop]!==undefined){saveProp[prop]=_prop;style[_prop]=val;return true;}});}}
function getCSSVal(prop){if(div.style[prop]!==undefined){return prop;}
else{var ret;some(prefix,function(_prefix){var _prop=ucFirst(_prefix)+ucFirst(prop);if(div.style[_prop]!==undefined){ret='-'+_prefix+'-'+prop;return true;}});return ret;}}
function ucFirst(str){return str.charAt(0).toUpperCase()+str.substr(1);}
function some(ary,callback){for(var i=0,len=ary.length;i<len;i++){if(callback(ary[i],i)){return true;}}
return false;}
function getTriangleSide(x1,y1,x2,y2){var x=Math.abs(x1-x2);var y=Math.abs(y1-y2);var z=Math.sqrt(Math.pow(x,2)+Math.pow(y,2));return{x:x,y:y,z:z};}
function getAngle(triangle){var cos=triangle.y/triangle.z;var radina=Math.acos(cos);return 180/(Math.PI/radina);}
if(typeof exports=='object'){module.exports=Flipsnap;}
else if(typeof define=='function'&&define.amd){define(function(){return Flipsnap;});}
else{window.Flipsnap=Flipsnap;}})(window,window.document);ns.provide({Flipsnap:window.Flipsnap});delete window.Flipsnap;});Namespace('jp.co.mixi.data.accessor')
.use('brook.util through,mapper')
.use('brook.model createModel')
.define(function(ns){'use strict';var createAccessor=function(data,propertyNames){var _get=function(value){if(!value)value={};_.each(propertyNames,function(propertyName){value[propertyName]=data[propertyName];});return value;};var _set=function(value){_.each(propertyNames,function(propertyName){data[propertyName]=value[propertyName];});};var accessor=ns.createModel({get:ns.mapper(_get),set:ns.through(_set)});accessor.funcGet=function(){accessor.notify('get').run();return _get();};accessor.funcSet=function(value){accessor.notify('set').run(value);};return accessor;};ns.provide({createAccessor:createAccessor});});Namespace("jp.mixi.model.utils")
.use('brook promise')
.use('brook.util cond,mapper')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.use('jp.co.mixi.nativeproxy isEnableNativeProxy')
.use('jp.co.mixi.net.jsonrpc.uploader')
.use('jp.co.mixi.net.jsonrpc.nativeproxy.uploader')
.define(function(ns){var FormGatewayJSONRPCUploader=ns.jp.co.mixi.net.jsonrpc.uploader.JSONRPCUploader;var NativeProxyJSONRPCUploader=ns.jp.co.mixi.net.jsonrpc.nativeproxy.uploader.JSONRPCUploader;var UNAUTHENTICATION_ERROR_CODE="401";var postKey=ns.gateway('rpc_post_key')||ns.gateway('ajax_post_key');var viewer=ns.gateway('viewer');var rpc=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:postKey});var nativeProxyRPC=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:postKey},true);if(NativeProxyJSONRPCUploader){var uploaderRPC=NativeProxyJSONRPCUploader.createService('/system/rpc.json',{auth_type:'postkey',secret:postKey});}
var appendViewerId=ns.mapper(function(request){request.viewer_id=viewer?viewer.id:ns.gateway('login_member_id');return request;});var changeParamsFormatForFileInputs=ns.mapper(function(v){var files=v.fileInputs;if(!files)return v;delete v.fileInputs;return{fileInputs:files,params:v};});var createRPCPromise=function(method,isEnableNativeProxyEngine){if(isEnableNativeProxyEngine)
return nativeProxyRPC.createRPCPromise(method);return rpc.createRPCPromise(method);};var createFormGatewayRPCPromise=function(method){var service=FormGatewayJSONRPCUploader.createService('system/rpc_form_gateway.pl',{auth_type:'postkey',secret:postKey});return service.createRPCPromise(method);};var getRPCPromiseCreator=function(method){return ns.promise(function(next,value){var rpcPromise;var data=value;if(ns.isEnableNativeProxy()){if(value&&value.fileInputs){if(!uploaderRPC)throw new Error('required nativeproxy uploader');rpcPromise=uploaderRPC.createRPCPromise(method);}else{rpcPromise=nativeProxyRPC.createRPCPromise(method);}}else{if(value&&value.fileInputs)data=value.params;rpcPromise=rpc.createRPCPromise(method);}
rpcPromise.subscribe(function(v){next(v);},data);});};var whenExpiredSessionToReload=ns.cond(function(value){return(value.response.error&&value.response.error.code==UNAUTHENTICATION_ERROR_CODE);},ns.promise(function(next,value){location.reload();}));ns.provide({appendViewerId:appendViewerId,changeParamsFormatForFileInputs:changeParamsFormatForFileInputs,createRPCPromise:createRPCPromise,createFormGatewayRPCPromise:createFormGatewayRPCPromise,getRPCPromiseCreator:getRPCPromiseCreator,whenExpiredSessionToReload:whenExpiredSessionToReload});});Namespace("jp.mixi.model.feedback")
.use('brook promise')
.use('brook.model createModel')
.use('jp.mixi.model.utils *')
.define(function(ns){var createKey=function(param){if(param.comment_member_id&&param.comment_post_time){return param.comment_member_id+"."+param.comment_post_time;}else{return param.owner_id+"."+param.id;}};var setParam=function(param){return ns.promise(function(next,value){if(!value||!(function(object){for(var o in object){return true;}
return false;})(value))return next(param);return next(value);});};var setFindLimit=ns.promise(function(next,value){value.limit=1;value.offset=0;next(value);});var models={};var createModel=function(service,param){if(models[service+"."+createKey(param)]){return models[service+"."+createKey(param)];}
var model=ns.createModel({'create':ns.promise().bind(setParam(param),ns.appendViewerId,ns.createRPCPromise('jp.mixi.'+service+'.feedback.create'),ns.whenExpiredSessionToReload),'delete':ns.promise().bind(setParam(param),ns.appendViewerId,ns.createRPCPromise('jp.mixi.'+service+'.feedback.delete'),ns.whenExpiredSessionToReload),'find':ns.promise().bind(setParam(param),ns.appendViewerId,ns.createRPCPromise('jp.mixi.'+service+'.feedback.find'),ns.whenExpiredSessionToReload),'findByLatest':ns.promise().bind(setParam(param),setFindLimit,ns.appendViewerId,ns.createRPCPromise('jp.mixi.'+service+'.feedback.find'),ns.whenExpiredSessionToReload)});models[service+"."+createKey(param)]=model;return model;};var deleteModel=function(service,param){if(param&&models[service+"."+createKey(param)]){models[service+"."+createKey(param)]=null;}};ns.provide({createFeedbackModel:createModel,deleteFeedbackModel:deleteModel});});Namespace('jp.mixi.model.relation.group')
.use('brook promise')
.use('brook.model createModel')
.use('brook.util cond,through,match,debug')
.use('jp.mixi.model.utils createRPCPromise,whenExpiredSessionToReload')
.define(function(ns){var cachedResult={};var isSuccess=function(rpcResult){return rpcResult.response.isSuccess();};var setCache=function(method){return ns.through(function(rpcResult){cachedResult[method]=rpcResult;});};var cacheUpdaterOf={'whenCreate':ns.through(function(rpcResult){if(!cachedResult.find){return;}
var created=rpcResult.response.result;var cachedGroups=cachedResult.find.response.result;cachedGroups.push(created);}),'whenUpdate':ns.through(function(rpcResult){if(!cachedResult.find){return;}
var updated=rpcResult.response.result;var cachedGroups=cachedResult.find.response.result;var beforeGroup=_.find(cachedGroups,function(group){return(group.group_id==updated.group_id);});var index=_(cachedGroups).indexOf(beforeGroup);cachedGroups[index]=updated;}),'whenDelete':ns.through(function(rpcResult){if(!cachedResult.find){return;}
var deletedId=rpcResult.request.group_id;var cachedGroups=cachedResult.find.response.result;var deleteGroup=_.find(cachedGroups,function(group){return group.group_id==deletedId;});cachedGroups.splice(_(cachedGroups).indexOf(deleteGroup),1);})};var model=ns.createModel({'create':ns.promise().bind(ns.createRPCPromise('jp.mixi.relation.group.create'),ns.cond(isSuccess,cacheUpdaterOf.whenCreate),ns.whenExpiredSessionToReload),'lookup':ns.promise().bind(ns.createRPCPromise('jp.mixi.relation.group.lookup'),ns.whenExpiredSessionToReload),'find':ns.promise(function(next,request){if(cachedResult.find){next(cachedResult.find);}else{ns.promise().bind(ns.createRPCPromise('jp.mixi.relation.group.find'),ns.whenExpiredSessionToReload,ns.cond(isSuccess,setCache('find'))).subscribe(next,request);}}),'delete':ns.promise().bind(ns.createRPCPromise('jp.mixi.relation.group.delete'),ns.cond(isSuccess,cacheUpdaterOf.whenDelete),ns.whenExpiredSessionToReload),'update':ns.promise().bind(ns.createRPCPromise('jp.mixi.relation.group.update'),ns.cond(isSuccess,cacheUpdaterOf.whenUpdate),ns.whenExpiredSessionToReload)});ns.provide({getGroupModel:function(){return model;}});});Namespace('jp.mixi.group.window.mode')
.define(function(ns){var MODE_LIST=[{id:'create',description:'\u30b0\u30eb\u30fc\u30d7\u65b0\u898f\u4f5c\u6210',isCreate:function(){return true;},isUpdate:function(){return false;},isView:function(){return false;},isAlert:function(){return false;}},{id:'update',description:'\u30b0\u30eb\u30fc\u30d7\u7de8\u96c6',isCreate:function(){return false;},isUpdate:function(){return true;},isView:function(){return false;},isAlert:function(){return false;}},{id:'view',description:'\u30b0\u30eb\u30fc\u30d7\u78ba\u8a8d',isCreate:function(){return false;},isUpdate:function(){return false;},isView:function(){return true;},isAlert:function(){return false;}},{id:'alert',description:'\u30b0\u30eb\u30fc\u30d7\u4f5c\u6210\u30fb\u7de8\u96c6',isCreate:function(){return false;},isUpdate:function(){return false;},isView:function(){return false;},isAlert:function(){return true;}}];ns.provide({getWindowModeById:function(id){var mode=_.find(MODE_LIST,function(mode){return mode.id==id;});if(!mode){throw"Invalid mode id.";}
return mode;}});});Namespace('jp.mixi.service.visibilitylevel')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.co.mixi.gateway gateway')
.use('jp.mixi.model.relation.group getGroupModel')
.use('brook.util through')
.define(function(ns){var GROUP_LEVEL_ID_OFFSET=10;var BASIC_LEVEL_SETTINGS=[{description:'\u5168\u4f53\u306b\u516c\u958b',nameText:'\u5168\u4f53',name:'public',level_id:4},{description:'\u53cb\u4eba\u306e\u53cb\u4eba\u307e\u3067\u516c\u958b',nameText:'\u53cb\u4eba\u306e\u53cb\u4eba',name:'foaf',level_id:3},{description:'\u53cb\u4eba\u307e\u3067\u516c\u958b',nameText:'\u53cb\u4eba',name:'friend',level_id:2},{description:'\u4ef2\u826f\u3057\u306b\u516c\u958b',nameText:'\u4ef2\u826f\u3057',name:'buddy',level_id:100},{description:'\u975e\u516c\u958b',nameText:'\u975e\u516c\u958b',name:'private',level_id:1}];var BASIC_LEVEL_TYPES={'voice':['public','foaf','friend','buddy'],'check':['public','foaf','friend','buddy','private']};var DEFAULT_SERVICE='voice';var _VisibilityLevel=ns.defineClass({initialize:function(args){var _self=this;_self.description=args.description;_self.subDescription=args.subDescription||"";_self.nameText=args.nameText;_self.name=args.name;_self.groupId=args.groupId;_self.levelId=args.levelId;_self.isDefault=args.isDefault;},isGroup:function(){return(this.name==='group');},asPrivacy:function(){return{name:this.name,group_id:this.groupId};},isDefaultLevel:function(){return this.isDefault;}
});var getBasicLevels=function(service,defaultLevelSetting){service=service||DEFAULT_SERVICE;defaultLevelSetting=defaultLevelSetting||_getVoiceDefaultLevelSettingFromGateWay();var basicLevelNames=BASIC_LEVEL_TYPES[service];if(!basicLevelNames){throw'invalid service name: '+service;}
var serviceLevelSettings=_.filter(BASIC_LEVEL_SETTINGS,function(setting){return _.include(basicLevelNames,setting.name);});var basicLevels=[];_.each(serviceLevelSettings,function(setting){var level=new _VisibilityLevel({description:setting.description,name:setting.name,nameText:setting.nameText,levelId:setting.level_id,isDefault:setting.level_id==defaultLevelSetting.id});basicLevels.push(level);});return basicLevels;};var getLevelFromGroup=function(group,defaultLevelSetting){defaultLevelSetting=defaultLevelSetting||_getVoiceDefaultLevelSettingFromGateWay();var levelId=Number(group.group_id)+
Number(GROUP_LEVEL_ID_OFFSET);var subDescription=_.sprintf('(%d\u4eba)',group.all_member_id_list.length);return new _VisibilityLevel({description:group.name,subDescription:subDescription,name:'group',nameText:group.name,groupId:group.group_id,levelId:levelId,isDefault:group.group_id==defaultLevelSetting.group_id});};var __defaultLevelUpdater=function(defaultLevel){var groupModel=ns.getGroupModel();groupModel.method('update').observe(ns.through(function(rpcResult){if(rpcResult.response.error){return;}
var group=rpcResult.response.result;if(defaultLevel.group_id==group.group_id){defaultLevel.description=group.name;}}));};var getDefaultLevel=function(defaultLevelSetting){if(!defaultLevelSetting){defaultLevelSetting=_getVoiceDefaultLevelSettingFromGateWay();}
if(defaultLevelSetting.name!=='group'){var basicLevelSetting=_.find(BASIC_LEVEL_SETTINGS,function(basicLevel){return(basicLevel.name===defaultLevelSetting.name);});return new _VisibilityLevel({description:basicLevelSetting.description,nameText:basicLevelSetting.nameText,name:basicLevelSetting.name,levelId:basicLevelSetting.level_id,isDefault:true});}else{__defaultLevelUpdater(defaultLevelSetting);var levelId=(Number(defaultLevelSetting.group_id)+
Number(GROUP_LEVEL_ID_OFFSET));return new _VisibilityLevel({description:defaultLevelSetting.description,nameText:defaultLevelSetting.description,name:defaultLevelSetting.name,groupId:defaultLevelSetting.group_id,levelId:levelId,isDefault:true});}};var _getVoiceDefaultLevelSettingFromGateWay=function(){var voiceSettings=ns.gateway('voice_settings');if(voiceSettings){return voiceSettings.default_level;}
throw'no information for default level setting: "defaultLevelSetting" arg nor "voice_settings" gateway';};ns.provide({getBasicLevels:getBasicLevels,getDefaultLevel:getDefaultLevel,getLevelFromGroup:getLevelFromGroup});});Namespace('jp.mixi.service.ui.levelselector')
.use('brook promise')
.use('brook.util through,wait,from,mapper')
.use('brook.model createModel')
.use('brook.channel sendChannel')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.mixi.model.relation.group getGroupModel')
.use('jp.mixi.group.window.mode getWindowModeById')
.use('jp.mixi.service.visibilitylevel getBasicLevels,getDefaultLevel,getLevelFromGroup')
.define(function(ns){var eventHandler;var DEFAULT_SERVICE='voice';var getLevelSelectorEventModel=function(){if(!eventHandler){eventHandler=ns.createModel();eventHandler.addMethod('open',ns.promise());eventHandler.addMethod('close',ns.promise());eventHandler.addMethod('changeLevel',ns.promise());}
return eventHandler;};var __isChildOf=function(parent,child){if(parent===child){return false;}
while(child&&child!==parent){child=child.parentNode;}
return child===parent;};var groupModel=ns.getGroupModel();var CSS_SELECTOR_OF={BASIC_LEVELS:'.JS_basicLevels',GROUP_LEVELS:'.JS_groupLevels',CREATE_GROUP:'.JS_createGroup',LOADING_GROUP:'.JS_loadingGroup',SELECTOR_CONTENT:'.JS_selectorContent',SELECTOR_LOADING:'.JS_selectorLoading'};var LevelSelector=ns.defineClass({initialize:function(args){var _self=this;_self._selectBoxElem=args.selectBoxElem;_self._levelListElem=args.levelListElem;_self._groupWindow=args.groupWindow;_self._aLevelTemplate=args.aLevelTemplate;_self._defaultLevelSetting=args.defaultLevelSetting;_self._service=args.service||DEFAULT_SERVICE;_self._levelElemOf={};_self._isOpen=false;_self._onClickBodyHandler=_self._onClickBody.bind(_self);_self._selectBoxElem.click(function(evt){if(evt){evt.preventDefault();evt.stopPropagation();}
if(_self._isOpen){_self._close().run();}else{_self._open().run();}});_self._eventHandler=getLevelSelectorEventModel();if(_self._groupWindow){_self._groupWindow.observeEvent('close',_self._close());}
_self.renderBasicLevels();_self._startObservingGroupModel();},observeEvent:function(eventName,promise){this._eventHandler.method(eventName)
.observe(promise);},setService:function(){var _self=this;return ns.through(function(value){if(value.defaultLevelSetting){_self._defaultLevelSetting=value.defaultLevelSetting;}
_self._service=value.service;_self.renderBasicLevels();});},setDefaultLevel:function(){var _self=this;return ns.through(function(){var defaultLevel=ns.getDefaultLevel(_self._defaultLevelSetting);_self._setLevel().run(defaultLevel);});},getSelectedLevel:function(){return this._currentLevel;},renderBasicLevels:function(){var _self=this;_self._levelListElem
.find(CSS_SELECTOR_OF.BASIC_LEVELS)
.html('');_.each(ns.getBasicLevels(_self._service,_self._defaultLevelSetting),function(level){var element=_self._createLevelElem(level);_self._levelListElem
.find(CSS_SELECTOR_OF.BASIC_LEVELS)
.append(element);});_self.setDefaultLevel().run();},_onClickBody:function(e){var _self=this;var isListClicked=__isChildOf(_self._levelListElem.get(0),e.target);if(isListClicked){return;}
var isBoxClicked=__isChildOf(_self._selectBoxElem.get(0),e.target)||(e.target===_self._selectBoxElem.get(0));if(isBoxClicked){return;}
_self._close().run();},_close:function(){var _self=this;return ns.through(function(){_self._isOpen=false;window.scrollTo(0,_self._scrollYWhenOpen);$j('body').unbind('click',_self._onClickBodyHandler);_self._levelListElem.hide();_self._levelListElem
.find(CSS_SELECTOR_OF.CREATE_GROUP)
.unbind('click');})
.bind(_self._eventHandler.notify('close'));},_open:function(){var _self=this;return ns.through(function(){_self._isOpen=true;_self._scrollYWhenOpen=(window.pageYOffset!==undefined)?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;_self._levelListElem.show();$j('body').click(_self._onClickBodyHandler);})
.bind(_self._eventHandler.notify('open'))
.bind(_self._showLoading())
.bind(_self._getCurrentGroups())
.bind(_self._renderGroupLevels())
.bind(_self._registerCreate())
.bind(ns.wait(200))
.bind(_self._setLevel())
.bind(_self._hideLoading());},_showLoading:function(){var _self=this;return ns.through(function(){var contentElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_CONTENT);var loadingElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_LOADING);contentElem.hide();loadingElem.show();});},_hideLoading:function(){var _self=this;return ns.through(function(){var contentElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_CONTENT);var loadingElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_LOADING);loadingElem.hide();contentElem.show();});},_startObservingGroupModel:function(){var _self=this;var MESSAGE_EDIT='\u300c%s\u300d\u3092\u7de8\u96c6\u3057\u307e\u3057\u305f';var MESSAGE_CREATE='\u300c%s\u300d\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f';var showToast=function(messageFormat){return ns.through(function(group){var TRUNCATE_LENGTH=12;var message=_.str.sprintf(messageFormat,_.str.truncate(group.name,TRUNCATE_LENGTH));ns.mapper(function(group){return{type:"normal",message:message};})
.bind(ns.wait(600))
.bind(ns.sendChannel('dialog_toast'))
.run(group);});};groupModel.method('create').observe(ns.promise(function(next,rpcResult){if(rpcResult.response.error){return;}
var group=rpcResult.response.result;next(group);})
.bind(_self._getCurrentGroups())
.bind(_self._renderGroupLevels())
.bind(function(next,currentGroups){next(_.last(currentGroups));})
.bind(showToast(MESSAGE_CREATE))
.bind(ns.mapper(function(group){return ns.getLevelFromGroup(group,_self._defaultLevelSetting);}))
.bind(_self._setLevel()));groupModel.method('update').observe(ns.promise(function(next,rpcResult){if(rpcResult.response.error){return;}
var group=rpcResult.response.result;next(group);})
.bind(showToast(MESSAGE_EDIT))
.bind(ns.mapper(function(group){return ns.getLevelFromGroup(group,_self._defaultLevelSetting);}))
.bind(_self._setLevel()));groupModel.method('delete').observe(_self.setDefaultLevel());},_setLevel:function(){var _self=this;return ns.through(function(level){if(level.levelId){_self._currentLevel=level;}
var currentLevelElem=_self._levelElemOf[_self._currentLevel.levelId];if(currentLevelElem){currentLevelElem.find('input').get(0).checked=true;}
var spanElem=_self._selectBoxElem.find('span');if(spanElem.length){spanElem.text(_self._currentLevel.description);}else{_self._selectBoxElem.text(_self._currentLevel.description);}})
.bind(_self._eventHandler.notify('changeLevel'));},_renderGroupLevels:function(){var _self=this;return ns.promise(function(next,groups){var loadingGroup=_self._levelListElem.find(CSS_SELECTOR_OF.LOADING_GROUP);_self._levelListElem
.find(CSS_SELECTOR_OF.GROUP_LEVELS)
.html('');_.each(groups,function(group){_self._appendGroup(group);});loadingGroup.hide();next(groups);});},_appendGroup:function(group){var _self=this;var level=ns.getLevelFromGroup(group,_self._defaultLevelSetting);var element=_self._createLevelElem(level);_self._levelListElem
.find(CSS_SELECTOR_OF.GROUP_LEVELS)
.append(element);},_registerCreate:function(){var _self=this;var mode=ns.getWindowModeById('create');return ns.through(function(groups){_self._levelListElem
.find(CSS_SELECTOR_OF.CREATE_GROUP)
.click(function(evt){if(evt){evt.preventDefault();evt.stopPropagation();}
_self._close()
.bind(ns.through(function(){window.scrollTo(0,0);}))
.bind(_self._groupWindow.open({currentGroups:groups,mode:mode}))
.run();});});},_createLevelElem:function(level){var _self=this;_self._aLevelTemplate.param(level);var element=$j(_self._aLevelTemplate.output());_self._levelElemOf[level.levelId]=element;element.click(function(evt){if(evt){evt.preventDefault();evt.stopPropagation();}
var spanElem=_self._selectBoxElem.find('span');if(spanElem.length){spanElem.text(level.description);}else{_self._selectBoxElem.text(level.description);}
_self._close()
.bind(_self._setLevel())
.run(level);});return element;},_getCurrentGroups:function(){return ns.from({})
.bind(groupModel.notify('find'))
.bind(ns.mapper(function(rpcResult){return rpcResult.response.result;}));}});ns.provide({LevelSelector:LevelSelector,getLevelSelectorEventModel:getLevelSelectorEventModel});});Namespace('jp.mixi.service.widget.announceballoon')
.use('brook promise')
.use('brook.util through,from')
.use('jp.co.mixi.gateway gateway')
.use('jp.mixi.model.utils createRPCPromise,whenExpiredSessionToReload')
.use('jp.mixi.service.analysis postUIEventLog')
.define(function(ns){'use strict';var CLOSE_METHOD_MAPPING={'hide':'hide','remove':'remove'};var elementsOf={};var __deactivete=_.once(function(){return ns.promise().bind(ns.createRPCPromise('jp.mixi.serviceactivation.peruser.deactivate'),ns.whenExpiredSessionToReload);});var registerElement=function(element,dataset){element=$j(element);var name=dataset.name;if(!elementsOf[name]){elementsOf[name]=[];}
elementsOf[name].push(element);element.click(function(evt){evt.preventDefault();evt.stopPropagation();});element.find('.JS_closeBalloon').click(function(evt){evt.preventDefault();evt.stopPropagation();(closeBalloon(name,dataset.closeAction).ready())();var eventName=dataset.eventName;if(eventName){ns.postUIEventLog(eventName);}});};var closeBalloon=function(name,action){var closeMethod=CLOSE_METHOD_MAPPING[action]||CLOSE_METHOD_MAPPING.hide;var hideElement=ns.promise(function(next,value){var elements=elementsOf[name];if(!elements){return;}
_.invoke(elements,closeMethod);next(value);});return ns.from({service:name})
.bind(hideElement)
.bind(__deactivete());};ns.provide({registerElement:registerElement,closeBalloon:closeBalloon});});Namespace('jp.mixi.service.widget.balloonanchor')
.use('brook *')
.use('brook.util *')
.define(function(ns){'use strict';var WAIT_TIME=500;var initialize=function(elem,dataset){ns.promise()
.bind(ns.wait(WAIT_TIME))
.bind(function(){var element=$j(elem);var balloon=document.getElementById(dataset.balloonId);if(!balloon){return;}
var jballoon=$j(balloon);var elementOffset=element.offset();var leftOffset=Math.floor(dataset.leftOffset||0);var topOffset=Math.floor(dataset.topOffset||0);var left=elementOffset.left+element.width()+leftOffset;var top=elementOffset.top+topOffset;var isOnlyTopOffset=(dataset.isOnlyTopOffset||0);jballoon.css('left',left);if(isOnlyTopOffset){jballoon.css('top',topOffset);}
else{jballoon.css('top',top);}
jballoon.show();var diff=jballoon.offset().left-left;jballoon.hide();jballoon.css('left',left-diff);if(_.isFunction(jballoon.fadeIn)){jballoon.fadeIn('fast');}
else{jballoon.show();}})
.run();};ns.provide({registerElement:initialize});});Namespace('jp.mixi.news.model.entry')
.use('brook promise')
.use('brook.model createModel')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.define(function(ns){'use strict';var rpc=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:ns.gateway('rpc_post_key'),internal_encoding:'euc-jp'});var createEntryModel=function(){var model=ns.createModel();model.addMethod('search',ns.promise().bind(rpc.createRPCPromise('jp.mixi.news.entry.search')));return model;};var entryModel=createEntryModel();ns.provide({getEntryModel:function(){return entryModel;}});});Namespace('jp.mixi.news.model.check')
.use('brook promise')
.use('brook.model createModel')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.define(function(ns){'use strict';var rpc=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:ns.gateway('rpc_post_key'),internal_encoding:'euc-jp'});var rpcPromiseForCreate=rpc.createRPCPromise('jp.mixi.news.check');var createCheckModel=function(){var checkModel=ns.createModel();checkModel.addMethod('create',ns.promise().bind(rpcPromiseForCreate));return checkModel;};var checkModel=createCheckModel();ns.provide({getCheckModel:function(){return checkModel;}});});Namespace('jp.mixi.news.model.voice')
.use('brook promise')
.use('brook.model createModel')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.define(function(ns){'use strict';var rpc=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:ns.gateway('rpc_post_key'),internal_encoding:'euc-jp'});var rpcPromiseForCreate=rpc.createRPCPromise('jp.mixi.voice.create');var createVoiceModel=function(){var voiceModel=ns.createModel();voiceModel.addMethod('create',ns.promise().bind(rpcPromiseForCreate));return voiceModel;};var voiceModel=createVoiceModel();ns.provide({getVoiceModel:function(){return voiceModel;}});});Namespace('jp.mixi.news.model.quote')
.use('brook promise')
.use('brook.model createModel')
.use('brook.util cond')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.define(function(ns){'use strict';var rpc=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:ns.gateway('rpc_post_key'),internal_encoding:'euc-jp'});var rpcPromiseForGetDiaryEntries=rpc.createRPCPromise('jp.mixi.news.quote.diary.getEntries');var is_diary=function(param){return(param.type=='diary');};var rpcPromiseForGetVoiceEntries=rpc.createRPCPromise('jp.mixi.news.quote.voice.getEntries');var is_voice=function(param){return(param.type=='voice');};var createQuoteModel=function(){var quoteModel=ns.createModel();quoteModel.addMethod('getEntries',ns.promise().bind(ns.cond(is_diary,rpcPromiseForGetDiaryEntries))
.bind(ns.cond(is_voice,rpcPromiseForGetVoiceEntries)));return quoteModel;};var quoteModel=createQuoteModel();ns.provide({getQuoteModel:function(){return quoteModel;}});});Namespace('jp.mixi.news.model.feedback')
.use('brook promise')
.use('brook.model createModel')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.define(function(ns){'use strict';var rpc=ns.JSONRPC.createService('/system/rpc.json',{auth_type:'postkey',secret:ns.gateway('rpc_post_key'),internal_encoding:'euc-jp'});var rpcPromiseForCreate=rpc.createRPCPromise('jp.mixi.plugins.favorite.createFavorite');var rpcPromiseForGetMember=rpc.createRPCPromise('jp.mixi.plugins.favorite.getMembers');var promiseForAlreadyCreated=rpcPromiseForGetMember.bind(ns.promise(function(n,v){var loginMemberId=ns.gateway('login_member_id');if(!loginMemberId){n({error:"login required"});return;}
if(v.response.error){n({error:v.response.error});return;}
if(!v.response.result){n({error:"no result"});return;}
if(v.response.result.error){n({error:v.response.result.error});return;}
var members=v.response.result.members;for(var i=0;i<members.length;i++){if(members[i].member_id==loginMemberId){n({result:true});return;}}
n({result:false});}));var createFeedbackModel=function(){var feedbackModel=ns.createModel();feedbackModel.addMethod('create',ns.promise().bind(rpcPromiseForCreate));feedbackModel.addMethod('getMembers',ns.promise().bind(rpcPromiseForGetMember));feedbackModel.addMethod('alreadyCreated',ns.promise().bind(promiseForAlreadyCreated));return feedbackModel;};var feedbackModel=createFeedbackModel();ns.provide({getFeedbackModel:function(){return feedbackModel;}});});Namespace('jp.mixi.news.model.quote.service')
.use('jp.co.mixi.data.accessor createAccessor')
.define(function(ns){'use strict';var data={service:'voice'};var accessor=ns.createAccessor(data,['service']);ns.provide({getSharedServiceModel:function(){return accessor;}});});Namespace('jp.mixi.news.model.quote.level')
.use('jp.co.mixi.data.accessor createAccessor')
.define(function(ns){'use strict';var PUBLIC_VOICE_LEVEL=4;var data={level:PUBLIC_VOICE_LEVEL};var accessor=ns.createAccessor(data,['level']);ns.provide({getSharedLevelModel:function(){return accessor;},getPublicLevel:function(){return PUBLIC_VOICE_LEVEL;}});});Namespace('jp.mixi.news.model.quote.twittersync')
.use('jp.co.mixi.data.accessor createAccessor')
.define(function(ns){'use strict';var data={state:false};var accessor=ns.createAccessor(data,['state']);ns.provide({getSharedTwitterSyncModel:function(){return accessor;}});});Namespace('jp.mixi.news.model.quote.posthomefeed')
.use('jp.co.mixi.data.accessor createAccessor')
.define(function(ns){'use strict';var data={state:true};var accessor=ns.createAccessor(data,['state']);ns.provide({getSharedPostHomeFeedModel:function(){return accessor;}});});Namespace('jp.mixi.news.model.quote.textcounter')
.use('jp.co.mixi.lang.string countByteLength')
.use('jp.mixi.news.model.quote.service getSharedServiceModel')
.use('jp.mixi.news.model.quote.twittersync getSharedTwitterSyncModel')
.define(function(ns){'use strict';var mixiMaxLength=150;var twitterMaxLength=140;var serviceModel=ns.getSharedServiceModel();var twitterSyncModel=ns.getSharedTwitterSyncModel();var getBodyLengthAndMaxLength=function(body,newsQuote,commentDelimiter){var currentService=serviceModel.funcGet().service;var getBodyLengthForMixi=function(){return Math.ceil(ns.countByteLength(getBody(),2)/2);};var getBodyLengthForTwitter=function(){return getBody().length;};var getBody=function(){var quoteText;if(currentService=='voice'){quoteText=commentDelimiter+newsQuote;}else{quoteText='';}
return body+quoteText;};var twitterSyncEnabled=twitterSyncModel.funcGet().state&&currentService=='voice';return{maxLength:twitterSyncEnabled?twitterMaxLength:mixiMaxLength,currentLength:twitterSyncEnabled?getBodyLengthForTwitter():getBodyLengthForMixi()};};ns.provide({getBodyLengthAndMaxLength:getBodyLengthAndMaxLength});});Namespace('jp.mixi.news.ui.togglebutton')
.use('jp.co.mixi.lang.class defineClass')
.use('brook.util through')
.define(function(ns){'use strict';var TOOLTIP_SHOW_DURATION_SP=1800;var TOOLTIP_SHOW_DURATION_PC=700;var ToggleButton=ns.defineClass({initialize:function(args){var self=this;self.jElement=args.element;self.jButton=args.button;self.jTooltip=args.tooltip;self.onMessage=args.onMessage;self.offMessage=args.offMessage;self.toggleModel=args.toggleModel;self.defaultState=args.defaultState||false;self.jButton.click(function(){var currentState=self.jElement.hasClass('on');var newState=!currentState;self.toggleModel.notify('set').run({state:newState});});var onChangeButtonState=ns.through(function(value){if(value.state){self.jElement.removeClass('off').addClass('on');self.jTooltip.html(self.onMessage);}else{self.jElement.removeClass('on').addClass('off');self.jTooltip.html(self.offMessage);}
if(!value.preventTooltip){self.showTooltip();}});self.toggleModel.method('set').observe(onChangeButtonState);self.toggleModel.notify('set').run({state:self.defaultState,preventTooltip:true});},showTooltip:function(){var self=this;if(self.jTooltip.fadeTo){self.jTooltip
.stop(true,true)
.fadeTo("normal",1)
.delay(TOOLTIP_SHOW_DURATION_PC)
.fadeOut("normal");}else{self.jTooltip
.css('-webkit-animation','none')
.css('animakit-animation','none')
.css('opacity',0)
.animate('tooltipBalloonFadeInOut',TOOLTIP_SHOW_DURATION_SP,'linear',function(){self.jTooltip.hide();})
.show();}}});ns.provide({ToggleButton:ToggleButton});});Namespace('jp.mixi.news.ui.photogroup.view')
.use('brook.channel sendChannel')
.use('flipsnap Flipsnap')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.ui.template getTemplateByElementId')
.use('jp.co.mixi.net.storage Storage')
.use('jp.mixi.service.analysis postUIEventLog')
.define(function(ns){'use strict';var STORAGE_KEY_PREFIX='point_for_group_';var EXPIRE_TIME=1000*60*60;var SHARE_BUTTON_CLICK_EVENT_NAME='news.photogroup.entry.share';var SET_NEWS_CHANNEL=ns.CURRENT_NAMESPACE+'.setNews';var NO_IMG_FILE='/img/smartphone/touch/common/noimage002.png';var UI_EVENT_NAME_SHOW='news.photogroup.view.entry.show';var PhotoGroupViewer=ns.defineClass({moveToPoint:function(index){this.flipsnap.moveToPoint(index);},initialize:function(element,data){this.jRoot=$j(element);this.jPhotoList=this.jRoot.find(data.photoListSelector);this.jTitle=this.jRoot.find(data.titleSelector);this.jDescription=this.jRoot.find(data.descriptionSelector);this.jNewsId=this.jRoot.find(data.newsIdSelector);this.jMediaLink=this.jRoot.find(data.mediaLinkSelector);this.jMediaCopyright=this.jRoot.find(data.mediaCopyrightSelector);this.jPublishedAt=this.jRoot.find(data.publishedAtSelector);this.jNextButton=this.jRoot.find(data.nextButtonSelector);this.jPrevButton=this.jRoot.find(data.prevButtonSelector);this.jFacebookButton=this.jRoot.find(data.facebookButtonSelector);this.jLineButton=this.jRoot.find(data.lineButtonSelector);this.jTwitterButton=this.jRoot.find(data.twitterButtonSelector);this.jQuoteDescription=this.jRoot.find(data.quoteDescriptionSelector);this.entryList=ns.gateway('news_entry_list');this.groupId=ns.gateway('group_id');this.startNewsId=ns.gateway('start_news_id');this.urlNewsPrefixSSL=ns.gateway('url_news_prefix_ssl');this.loginMemberId=ns.gateway('login_member_id');this.viewerWidth=data.viewerWidth;this.flipsnap=undefined;this.currentPosition=0;this.shareInfoForCurrentPosition=undefined;this.setNewsTimerId=undefined;this.assignPhotoList();this.initFlipsnap(this.getStartPoint());this.showEntry();var self=this;$j(window).resize(function(){self.onResize();});this.jNextButton.click(function(){self.onNextButtonClick();});this.jPrevButton.click(function(){self.onPrevButtonClick();});this.jFacebookButton.click(this.makeShareButtonEventHandler(self,'facebook'));this.jLineButton.click(this.makeShareButtonEventHandler(self,'line'));this.jTwitterButton.click(this.makeShareButtonEventHandler(self,'twitter'));},assignPhotoList:function(){var template=ns.getTemplateByElementId('photo_group_entry_row');template.param({news_entry_list:this.entryList});var html=template.output();this.jPhotoList.html(html);},getStartPoint:function(){if(this.startNewsId){for(var i=0;i<this.entryList.length;i++){if(this.entryList[i].news_id==this.startNewsId){return i;}}}
if(ns.Storage.isAvailable()){return ns.Storage.load(ns.CURRENT_NAMESPACE,STORAGE_KEY_PREFIX+this.groupId)||0;}
return 0;},initFlipsnap:function(startPoint){this.currentPosition=startPoint;var width=this.viewerWidth?this.viewerWidth:this.jRoot.width();this.flipsnap=ns.Flipsnap(this.jPhotoList.get(0),{distance:width});this.jPhotoList.width(width*this.entryList.length);this.flipsnap.moveToPoint(startPoint);var self=this;$j(this.flipsnap.element).on('fsmoveend',function(){self.currentPosition=self.flipsnap.currentPoint;self.showEntryWithDelay();});},onResize:function(){if(this.viewerWidth)return;var width=this.jRoot.width();this.jPhotoList.width(width*this.entryList.length);this.flipsnap.distance=width;this.flipsnap.refresh();},onNextButtonClick:function(){this.flipsnap.toNext();},onPrevButtonClick:function(){this.flipsnap.toPrev();},makeShareButtonEventHandler:function(self,service){return function(evt){evt.preventDefault();var url=self.shareInfoForCurrentPosition.url[service];var pageName=self.shareInfoForCurrentPosition.pageName[service];ns.postUIEventLog(SHARE_BUTTON_CLICK_EVENT_NAME,pageName,function(){location.href=url;});};},showEntryWithDelay:function(){this.loadPhotoWithDelay(50);this.setNewsWithDelay(300);this.postShowEntryLog();},showEntry:function(){this.loadPhoto();this.setNews();this.postShowEntryLog();},setNewsWithDelay:function(delay){if(this.setNewsTimerId){clearTimeout(this.setNewsTimerId);}
var self=this;this.setNewsTimerId=setTimeout(function(){self.setNews();self.setNewsTimerId=null;},delay);this.saveCurrentPoint(this.flipsnap.currentPoint);},setNews:function(){var entry=this.entryList[this.currentPosition];this.setShareInfo();this.jTitle.text(entry.original_title).attr('href',entry.news_url);this.jDescription.html(entry.description);this.jDescription.toggleClass('decoratable',(entry.can_decorate_description?true:false));this.jQuoteDescription.html(entry.quote_voice_info.title+" "+entry.quote_voice_info.short_url);this.jNewsId.text(entry.news_id);this.jMediaLink.text(entry.media_name).attr('href',entry.media_url);this.jMediaCopyright.text(entry.media_copyright);this.jPublishedAt.text(this.formatDate(entry.created_at));this.setVisibility(this.jNextButton,this.flipsnap.hasNext());this.setVisibility(this.jPrevButton,this.flipsnap.hasPrev());ns.sendChannel(SET_NEWS_CHANNEL).run({entry:entry,viewer:this,index:this.currentPosition});},formatDate:function(datestring){var date=new Date(datestring.replace(/-/g,'/'));return date.getFullYear()+'\u5e74'+(date.getMonth()+1)+'\u6708'+date.getDate()+'\u65e5 '+date.getHours()+'\u6642'+date.getMinutes()+'\u5206';},setShareInfo:function(){var entry=this.entryList[this.currentPosition];var newsUrl=this.urlNewsPrefixSSL+'view_photo_group.pl?group_id='+this.groupId+'&start_news_id='+entry.news_id;var newsShareUrl=newsUrl+'&share_from=view_photo_group';var url={newsUrl:newsUrl,facebook:'http://www.facebook.com/sharer.php?u='+encodeURIComponent(newsShareUrl+'&from=facebook'),line:'http://line.me/R/msg/text/?'+encodeURIComponent(entry.quote_voice_info.title+"\r\n"+newsShareUrl+'&from=line'),twitter:'http://twitter.com/share?text='+encodeURIComponent(entry.quote_voice_info.title)+'&url='+encodeURIComponent(newsShareUrl+'&from=twitter')};var pageName={};var self=this;_.each(['facebook','line','twitter'],function(shareTo){pageName[shareTo]='group_id='+self.groupId+'&news_id='+entry.news_id+'&share_to='+shareTo+'&share_from=view_photo_group';});this.shareInfoForCurrentPosition={url:url,pageName:pageName};},loadPhotoWithDelay:function(delay){var self=this;setTimeout(function(){self.loadPhoto();},delay);},loadPhoto:function(){var showError=function(){jImg.attr('src',NO_IMG_FILE);};for(var i=-1;i<=1;i++){var tmpPos=this.currentPosition+i;if(tmpPos<0||tmpPos>=this.entryList.length)continue;var entry=this.entryList[tmpPos];var jImg=this.jPhotoList.find('img').eq(tmpPos);jImg.error(showError);jImg.attr('src',entry.original_image_url);jImg.show();}},setVisibility:function(jElement,isVisible){if(isVisible){jElement.show();}else{jElement.hide();}},saveCurrentPoint:function(currentPoint){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date()).getTime()+EXPIRE_TIME);ns.Storage.save(ns.CURRENT_NAMESPACE,STORAGE_KEY_PREFIX+this.groupId,currentPoint,expireDate);}},postShowEntryLog:function(){var entry=this.entryList[this.currentPosition];var eventName=UI_EVENT_NAME_SHOW;var pageName='group_id='+this.groupId+'&news_id='+entry.news_id;ns.postUIEventLog(eventName,pageName);}});ns.provide({PhotoGroupViewer:function(element,data){return new PhotoGroupViewer(element,data);}});});Namespace('jp.mixi.news.widget.quote.feedback')
.use('brook promise')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.co.mixi.lang parseIntAsDecimal')
.use("jp.mixi.model.feedback createFeedbackModel")
.define(function(ns){'use strict';var MESSAGE_FAILED_FEEDBACK='\u3053\u306e\u6295\u7a3f\u306b\u30a4\u30a4\u30cd\u3067\u304d\u307e\u305b\u3093';var QuoteFeedback=ns.defineClass({initialize:function(element,data){var self=this;self.feedbackClass=data.feedbackClass;self.feedbackCountClass=data.feedbackCountClass;self.jFeedback=$j(element);var feedbackModel=ns.createFeedbackModel('voice',{id:data.postTime,owner_id:data.ownerId});self.jFeedback.find(self.feedbackClass).click(function(){ns.promise().bind(ns.promise(self.beforeFeedbackFunc()))
.bind(feedbackModel.notify('create'))
.bind(ns.promise(self.afterFeedbackFunc())).run();});var memberId=ns.parseIntAsDecimal(ns.gateway('login_member_id'));if(data.isFeedbacked||data.ownerId==memberId){self.off();}},beforeFeedbackFunc:function(){var self=this;return function(next,param){self.off();next(param);};},afterFeedbackFunc:function(){var self=this;return function(next,param){if(param.response.result){var jCounter=self.jFeedback.find(self.feedbackCountClass);jCounter.text(ns.parseIntAsDecimal(jCounter.text())+1);}else{alert(MESSAGE_FAILED_FEEDBACK);}};},off:function(){var self=this;self.jFeedback.find(self.feedbackClass).hide();}});ns.provide({registerElement:function(element,data){new QuoteFeedback(element,data);}});});Namespace('jp.mixi.news.widget.quote.form')
.use('brook promise')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.co.mixi.lang parseIntAsDecimal')
.use('jp.mixi.news.model.voice getVoiceModel')
.use('jp.mixi.news.model.quote.level getSharedLevelModel')
.use('jp.mixi.news.model.quote.twittersync getSharedTwitterSyncModel')
.use('jp.mixi.news.model.quote.posthomefeed getSharedPostHomeFeedModel')
.define(function(ns){'use strict';var PUBLIC_LEVEL=4;var BLOCKED_REQUEST_CODE=-32098;var QuoteSubmitVoice=ns.defineClass({initialize:function(element,data){var self=this;self.jElement=$j(element);self.jSubmitElement=self.jElement.find(data.submitElement);self.jReplaceQuoteTextElement=self.jElement.find(data.replaceQuoteTextElement);self.jBodyElement=self.jElement.find(data.bodyElement);self.jQuoteTextElement=self.jElement.find(data.quoteTextElement);self.jFailedElement=self.jElement.find(data.failedElement);self.jBlockedElement=self.jElement.find(data.blockedElement);self.jNewsIdElement=self.jElement.find(data.newsIdElement);self.newsId=data.newsId;if(data.skipPostFeedElement)self.jSkipPostFeedElement=self.jElement.find(data.skipPostFeedElement);if(data.twitterSyncElement)self.jTwitterSyncElement=self.jElement.find(data.twitterSyncElement);if(data.levelElement)self.jLevelElement=self.jElement.find(data.levelElement);self.commentDelimiter=data.commentDelimiter;self.locationHref=data.locationHref;self.via=data.via;var memberId=ns.parseIntAsDecimal(ns.gateway('login_member_id'));var voiceModel=ns.getVoiceModel();self.jSubmitElement.click(function(){var postParam={viewer_id:memberId,owner_id:memberId,body:self.getBody(),level:self.getLevel(),news_id:self.getNewsId(),via:self.via,twitter_sync:self.getTwitterSync(),skip_post_feed:self.getSkipHomeFeed()};ns.promise().bind(voiceModel.notify('create'))
.bind(ns.promise(self.afterSubmitVoiceFunc()))
.run(postParam);});},afterSubmitVoiceFunc:function(){var self=this;return function(next,param){if(param.response.result){self.jBodyElement.val('');self.jQuoteTextElement.hide();self.fadeOut(self.jReplaceQuoteTextElement);self.fadeIn(self.jReplaceQuoteTextElement);if(self.locationHref&&param.request.level==PUBLIC_LEVEL){window.location.href=self.locationHref;}}else{if(BLOCKED_REQUEST_CODE===param.response.error.code){self.fadeIn(self.jBlockedElement);}else{self.fadeIn(self.jFailedElement);}}};},getBody:function(){var self=this;var body=self.jBodyElement.val();return(body)?body+self.commentDelimiter+self.jQuoteTextElement.text():self.jQuoteTextElement.text();},getNewsId:function(){var self=this;return self.newsId?self.newsId:ns.parseIntAsDecimal(self.jNewsIdElement.text());},getLevel:function(){var self=this;return self.jLevelElement?self.jLevelElement.val():ns.getSharedLevelModel().funcGet().level;},getTwitterSync:function(){var self=this;return self.jTwitterSyncElement?self.jTwitterSyncElement.prop('checked'):ns.getSharedTwitterSyncModel().funcGet().state;},getSkipHomeFeed:function(){var self=this;return self.jSkipPostFeedElement?self.jSkipPostFeedElement.prop('checked'):!ns.getSharedPostHomeFeedModel().funcGet().state;},fadeIn:function(jElement){return jElement.fadeIn?jElement.fadeIn("slow"):jElement.show();},fadeOut:function(jElement){return jElement.fadeOut?jElement.fadeOut("slow"):jElement.hide();}});ns.provide({registerElement:function(element,data){new QuoteSubmitVoice(element,data);}});});Namespace('jp.mixi.news.widget.quote.form.textarea')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.mixi.news.model.quote.textcounter getBodyLengthAndMaxLength')
.define(function(ns){'use strict';var OVER_MESSAGE='\u6587\u5b57\u30aa\u30fc\u30d0\u30fc\u3057\u3066\u3044\u307e\u3059\u3002';var QuoteCounter=ns.defineClass({initialize:function(element,data){var self=this;self.jRootElement=$j(element);self.jCounterElement=self.jRootElement.find(data.counterElement);self.jMaxLengthElement=self.jRootElement.find(data.maxLengthElement);self.jSubmitElement=self.jRootElement.find(data.submitElement);self.jErrorMessageElement=self.jRootElement.find(data.errorMessageElement);self.jBodyElement=self.jRootElement.find(data.bodyElement);self.jQuoteTextElement=self.jRootElement.find(data.quoteTextElement);self.commentDelimiter=data.commentDelimiter;self.currentService=data.defaultService;self.observeBodyTextChange();},observeBodyTextChange:function(){var self=this;var loop=function(){var lengthInfo=ns.getBodyLengthAndMaxLength(self.jBodyElement.val(),self.jQuoteTextElement.text(),self.commentDelimiter);var currentLength=lengthInfo.currentLength;var maxLength=lengthInfo.maxLength;self.jCounterElement.text(currentLength);self.jMaxLengthElement.text(maxLength);if(currentLength>maxLength){self.jCounterElement.addClass('over');self.jErrorMessageElement.show();self.jSubmitElement.prop("disabled",true);}else{self.jCounterElement.removeClass('over');self.jErrorMessageElement.hide();self.jSubmitElement.prop("disabled",false);}
setTimeout(loop,200);};loop();}});ns.provide({registerElement:function(element,data){new QuoteCounter(element,data);}});});Namespace('jp.mixi.news.widget.quote.form.twittersync')
.use('brook.util through')
.use('jp.mixi.news.model.quote.service getSharedServiceModel')
.use('jp.mixi.news.model.quote.twittersync getSharedTwitterSyncModel')
.use('jp.mixi.news.ui.togglebutton ToggleButton')
.use('jp.co.mixi.net.storage Storage')
.define(function(ns){'use strict';var STORAGE_NAME_SPACE='jp.mixi.news.widget.quote.form.twittersync';var STORAGE_KEY='twitter_post_enabled';var STORAGE_EXPIRE_TIME=1000*60*60*24*30;var getDefaultState=function(){var defaultState=false;if(ns.Storage.isAvailable()){defaultState=ns.Storage.load(STORAGE_NAME_SPACE,STORAGE_KEY)||false;}
return defaultState;};var initialize=function(element,dataset){var jElement=$j(element);var twitterSyncModel=ns.getSharedTwitterSyncModel();new ns.ToggleButton({element:jElement,button:jElement.find(dataset.twitterSyncButton),tooltip:jElement.find(dataset.twitterSyncTooltip),onMessage:dataset.twitterSyncOnMessage,offMessage:dataset.twitterSyncOffMessage,toggleModel:twitterSyncModel,defaultState:getDefaultState()});var observeModel=function(){var onChangeService=ns.through(function(value){if(value.service==='voice'){jElement.show();}else{jElement.hide();}});var serviceModel=ns.getSharedServiceModel();serviceModel.notify('get').bind(onChangeService).run();serviceModel.method('set').observe(onChangeService);var onToggleButtonChangeState=ns.through(function(value){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date()).getTime()+STORAGE_EXPIRE_TIME);ns.Storage.save(STORAGE_NAME_SPACE,STORAGE_KEY,value.state,expireDate);}});twitterSyncModel.method('set').observe(onToggleButtonChangeState);};observeModel();};ns.provide({registerElement:initialize});});Namespace('jp.mixi.news.widget.quote.form.level')
.use('brook.util through')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.ui.template getTemplateByElementId')
.use('jp.mixi.service.ui.levelselector LevelSelector')
.use('jp.mixi.news.model.quote.service getSharedServiceModel')
.use('jp.mixi.news.model.quote.level getSharedLevelModel')
.define(function(ns){var DEFAULT_SERVICE='voice';var initialize=function(element,dataset){var jRoot=$j(element);var jOpenSelectorButton=jRoot.find(dataset.openSelectorButton);var jLevelSelectorPanel=$j(dataset.levelSelectorPanel);var levelSelectorRowTemplate=dataset.levelSelectorRowTemplate;var currentService;var serviceModel=ns.getSharedServiceModel();var levelModel=ns.getSharedLevelModel();var defaultLevelSettings={'voice':ns.gateway('voice_default_setting'),'check':ns.gateway('check_default_setting')};var levelSelector=new ns.LevelSelector({selectBoxElem:jOpenSelectorButton,levelListElem:jLevelSelectorPanel,aLevelTemplate:ns.getTemplateByElementId(levelSelectorRowTemplate),service:DEFAULT_SERVICE,defaultLevelSetting:defaultLevelSettings[DEFAULT_SERVICE]});var onLevelChange=ns.through(function(value){var selectedLevel=levelSelector.getSelectedLevel();levelModel.notify('set').run({level:selectedLevel.levelId,service:currentService});});levelSelector.observeEvent('changeLevel',onLevelChange);var onServiceChange=ns.through(function(value){currentService=value.service;levelSelector.setService().run({service:currentService,defaultLevelSetting:defaultLevelSettings[currentService]});});serviceModel.notify('get').bind(onServiceChange).run();serviceModel.method('set').observe(onServiceChange);};ns.provide({registerElement:function(element,dataset){initialize(element,dataset);}});});Namespace('jp.mixi.news.widget.quote.form.posthomefeed')
.use('brook.util through')
.use('jp.co.mixi.net.storage Storage')
.use('jp.mixi.news.model.quote.service getSharedServiceModel')
.use('jp.mixi.news.model.quote.level getSharedLevelModel,getPublicLevel')
.use('jp.mixi.news.model.quote.posthomefeed getSharedPostHomeFeedModel')
.use('jp.mixi.news.ui.togglebutton ToggleButton')
.define(function(ns){'use strict';var STORAGE_NAMESPACE='jp.mixi.news.widget.quote.form.posthomefeed';var SELECTED_SERVICE_KEY='posthomefeed_enabled';var EXPIRE_TIME=1000*60*60*24*30;var publicLevel=ns.getPublicLevel();var initialize=function(element,dataset){var jElement=$j(element);var service;var level;var model=ns.getSharedPostHomeFeedModel();var initializeToggleButton=function(){var defaultState=true;if(ns.Storage.isAvailable()){var state=ns.Storage.load(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY);if(state!==null)defaultState=state;}
new ns.ToggleButton({element:jElement,button:jElement.find(dataset.postHomeFeedButton),tooltip:jElement.find(dataset.postHomeFeedTooltip),onMessage:dataset.postHomeFeedOnMessage,offMessage:dataset.postHomeFeedOffMessage,toggleModel:model,defaultState:defaultState});};var changeVisibility=function(){if(service==='voice'&&level===publicLevel){jElement.show();}else{jElement.hide();}};var observeModel=function(){var onChangeService=ns.through(function(value){service=value.service;changeVisibility();});var onChangeLevel=ns.through(function(value){level=value.level;changeVisibility();});var onChangePostHomeFeed=ns.through(function(value){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date()).getTime()+EXPIRE_TIME);ns.Storage.save(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY,value.state,expireDate);}});model.method('set').observe(onChangePostHomeFeed);var serviceModel=ns.getSharedServiceModel();serviceModel.notify('get').bind(onChangeService).run();serviceModel.method('set').observe(onChangeService);var levelModel=ns.getSharedLevelModel();levelModel.notify('get').bind(onChangeLevel).run();levelModel.method('set').observe(onChangeLevel);};initializeToggleButton();observeModel();};ns.provide({registerElement:initialize});});Namespace('jp.mixi.news.widget.quote.form.deprecated.level')
.use('brook.channel sendChannel')
.use('jp.co.mixi.lang.class defineClass')
.define(function(ns){'use strict';var SelectVoiceLevel=ns.defineClass({initialize:function(elem,dataset){this.element=elem;this.dataset=dataset;this.registerHandler();},registerHandler:function(){var _self=this;ns.sendChannel('jp.mixi.news.widget.quote.voice.level.changed').run({level:parseInt(_self.dataset.defaultVoiceLevel,10)});if(parseInt(_self.dataset.isPremium,10)===1&&parseInt(_self.dataset.defaultVoiceLevel,10)===parseInt(_self.dataset.publicVoiceLevel,10))
{$j(_self.dataset.checkboxElement).show();$j(_self.dataset.checkboxLabelElement).show();}
_self.element.change(function(){ns.sendChannel('jp.mixi.news.widget.quote.voice.level.changed').run({level:parseInt($j(_self.element).val(),10)});if(parseInt(_self.dataset.isPremium,10)===0){return;}
if(parseInt($j(_self.element).val(),10)===parseInt(_self.dataset.publicVoiceLevel,10)){$j(_self.dataset.checkboxElement).show();$j(_self.dataset.checkboxLabelElement).show();}else{$j(_self.dataset.checkboxElement).hide();$j(_self.dataset.checkboxLabelElement).hide();}});}});ns.provide({registerElement:function(elem,dataset){new SelectVoiceLevel($j(elem),dataset);}});});Namespace('jp.mixi.news.widget.quote.form.deprecated.saveskipfeed')
.use('jp.co.mixi.net.storage Storage')
.use('jp.co.mixi.lang.class defineClass')
.define(function(ns){'use strict';var STORAGE_NAMESPACE='jp.mixi.news.widget.quote.voice.saveskipfeed';var SELECTED_SERVICE_KEY='checked_service';var EXPIRE_TIME=1000*60*60*24*30;var SkipFeedCheckBox=ns.defineClass({initialize:function(elem,dataset){this.element=elem;var service=Boolean(parseInt(dataset.defaultService,10));if(ns.Storage.isAvailable()){service=ns.Storage.load(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY);}
if(service===true){$j(elem).prop('checked',true);}else{$j(elem).prop('checked',false);}
this.registerHandler();},registerHandler:function(){var _self=this;_self.element.click(function(){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date()).getTime()+EXPIRE_TIME);ns.Storage.save(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY,_self.element.prop('checked'),expireDate);}});}});ns.provide({registerElement:function(element,dataset){new SkipFeedCheckBox($j(element),dataset);}});});Namespace('jp.mixi.news.widget.category.entry.detail')
.use('jp.co.mixi.lang.class defineClass')
.use('jp.co.mixi.net.storage Storage')
.define(function(ns){'use strict';var STORAGE_NAMESPACE='jp.mixi.news.widget.category.photo';var SELECTED_SERVICE_KEY='status';var EXPIRE_TIME=1000*60*60*24*90;var CategoryPhoto=ns.defineClass({initialize:function(element,data){var _self=this;_self.jShowPhotoButtonElement=$j(data.showPhotoButtonElement);_self.jHidePhotoButtonElement=$j(data.hidePhotoButtonElement);_self.jEntryDetailElement=$j(data.entryDetailElement);if(_self.getStatus()=='visible'){_self.change('visible');}
_self.jShowPhotoButtonElement.click(function(){_self.change('visible');});_self.jHidePhotoButtonElement.click(function(){_self.change('invisible');});},change:function(status){var _self=this;_self.saveStatus(status);if(status=='visible'){_self.jShowPhotoButtonElement.hide();_self.jHidePhotoButtonElement.show();_self.jEntryDetailElement.show();}else{_self.jShowPhotoButtonElement.show();_self.jHidePhotoButtonElement.hide();_self.jEntryDetailElement.hide();}},getStatus:function(){if(ns.Storage.isAvailable()){return ns.Storage.load(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY)||'visible';}else{return'visible';}},saveStatus:function(status){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date()).getTime()+EXPIRE_TIME);ns.Storage.save(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY,status,expireDate);}}});ns.provide({registerElement:function(element,data){new CategoryPhoto(element,data);}});});Namespace('jp.mixi.news.widget.postuievent')
.use('jp.mixi.service.analysis postUIEventLog')
.define(function(ns){'use strict';ns.provide({registerElement:function(element,dataset){$j(element).on('click',function(evt){evt.preventDefault();ns.postUIEventLog(dataset.eventName,dataset.pageName,function(){location.href=element.href;});});}});});