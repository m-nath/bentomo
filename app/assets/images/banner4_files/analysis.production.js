Mixi=Mixi||{};Mixi.Analysis=(function(){var ENGINE_ACCOUNT=(Mixi.Gateway.getParam('RUN_MODE')!=='production')?"mixijpdev":"mixijpmain";var ENGINE_SAMPLING_RATIO=(Mixi.Gateway.getParam('RUN_MODE')!=='production')?100:3.5;var EVENTS={"friend.delete":{"category":"default","actionType":"friend.delete","event":"event13"},"video.invite.introduce":{"category":"default","actionType":"other","event":"event7"},"community.bbs.comment.create":{"category":"comment","actionType":"public","event":"event5"},"diary.create":{"category":"post","actionType":"friend","event":"event1"},"photo.create":{"category":"post","actionType":"friend","event":"event1"},"community.event.comment.create":{"category":"comment","actionType":"public","event":"event5"},"search.contents.diary":{"category":"default","actionType":"search.contents","event":"event15"},"search.contents.web":{"category":"default","actionType":"search.contents","event":"event15"},"profile.photo.set":{"category":"default","actionType":"profile","event":"event9"},"friend.request":{"category":"default","actionType":"friend.request","event":"event12"},"setting.extension.edit":{"category":"default","actionType":"setting","event":"event8"},"application.join<invitation>":{"category":"default","actionType":"other","event":"event7"},"setting.network.school.join":{"category":"default","actionType":"setting","event":"event8"},"setting.basic.edit":{"category":"default","actionType":"setting","event":"event8"},"application.join":{"category":"default","actionType":"other","event":"event7"},"community.create":{"category":"default","actionType":"other","event":"event7"},"calendar.event.create":{"category":"post","actionType":"friend","event":"event1"},"setting.keyword.set":{"category":"default","actionType":"setting","event":"event8"},"photo.album.create":{"category":"default","actionType":"other","event":"event7"},"setting.premium.set":{"category":"default","actionType":"setting","event":"event8"},"diary.comment.create":{"category":"comment","actionType":"friend","event":"event3"},"community.enquete.comment.create":{"category":"comment","actionType":"public","event":"event5"},"friend.intro.create":{"category":"default","actionType":"other","event":"event7"},"search.contents.video":{"category":"default","actionType":"search.contents","event":"event15"},"invitation.friend<application>":{"category":"default","actionType":"invitation","event":"event10"},"friend.request<mail>":{"category":"default","actionType":"friend.request","event":"event12"},"search.friend":{"category":"default","actionType":"search.friend","event":"event14"},"invitation.friend<registeration>":{"category":"default","actionType":"invitation","event":"event10"},"review.create":{"category":"default","actionType":"other","event":"event7"},"application.introduce":{"category":"default","actionType":"other","event":"event7"},"community.join<invitation>":{"category":"default","actionType":"other","event":"event7"},"community.join":{"category":"default","actionType":"other","event":"event7"},"search.contents.news":{"category":"default","actionType":"search.contents","event":"event15"},"invitation.friend":{"category":"default","actionType":"invitation","event":"event10"},"friend.setting.mylist.add":{"category":"default","actionType":"setting","event":"event8"},"friend.setting.mylist.set.ok":{"category":"default","actionType":"setting","event":"event8"},"register<registration>":{"category":"default","actionType":"register","registerType":"registration","event":"event11"},"video.comment.create":{"category":"default","actionType":"other","event":"event7"},"search.contents.photo":{"category":"default","actionType":"search.contents","event":"event15"},"message.reply":{"category":"default","actionType":"direct","event":"event6"},"profile.edit":{"category":"default","actionType":"profile","event":"event9"},"message.create":{"category":"default","actionType":"direct","event":"event6"},"friend.setting.buddy.set":{"category":"default","actionType":"setting","event":"event8"},"register<invitation>":{"category":"default","actionType":"register","registerType":"invitation","event":"event11"},"profile.skin.set":{"category":"default","actionType":"profile","event":"event9"},"community.event.create":{"category":"post","actionType":"public","event":"event4"},"photo.album.introduce":{"category":"default","actionType":"other","event":"event7"},"community.introduce":{"category":"default","actionType":"other","event":"event7"},"search.contents.review":{"category":"default","actionType":"search.contents","event":"event15"},"community.enquete.create":{"category":"post","actionType":"public","event":"event4"},"voice.comment.create":{"category":"comment","actionType":"friend","event":"event3"},"search.contents.community":{"category":"default","actionType":"search.contents","event":"event15"},"voice.create":{"category":"post","actionType":"friend","event":"event1"},"community.bbs.create":{"category":"post","actionType":"public","event":"event4"},"video.create":{"category":"default","actionType":"other","event":"event7"},"album.comment.create":{"category":"comment","actionType":"friend","event":"event3"},"application.view":{"category":"default","actionType":"view","event":"event16"},"invitation.friend<gmail>":{"category":"default","actionType":"invitaion","event":"event10"},"friend.request<gmail>":{"category":"default","actionType":"friend.request","event":"event12"},"voice.feedback":{"category":"feedback","actionType":"friend","event":"event2"},"diary.feedback":{"category":"feedback","actionType":"friend","event":"event2"},"calendar.feedback":{"category":"feedback","actionType":"friend","event":"event2"},"calendar.comment.create":{"category":"comment","actionType":"friend","event":"event3"},"calendar.join":{"category":"default","actionType":"other","event":"event7"},"check.in.create":{"category":"post","actionType":"friend","event":"event1"},"calendar.invite":{"category":"default","actionType":"other","event":"event7"},"profile.photo.edit":{"category":"default","actionType":"profile","event":"event9"},"photo.comment.create":{"category":"comment","actionType":"friend","event":"event3"},"profile.photo.recommend":{"category":"default","actionType":"other","event":"event7"},"photo.feedback":{"category":"feedback","actionType":"friend","event":"event2"}};var EventObject=function(eventName,extraOptions){var eventData=EVENTS[eventName];if(!eventData){throw(new Error('undefined event'));}
this.eventName=eventName;this.category=eventData.category;this.actionType=eventData.actionType;this.signature=eventData.event;if(extraOptions){this.postLevel=extraOptions.postLevel;}
return this;};EventObject.prototype.fire=function(){};var page;var viewer;var owner;var relation;var service;var isViaShowFriend=(/_fof/).test(location.search);var _composeRequestPath=function(){if(page[0].match(/show_friend/)||page[0].match(/add_friend/)){return(isViaShowFriend)?service[0]:'';}
return service[0]||'_other';};var _defaultFor=function(word,defaultValue){if(!word){return defaultValue;}
return word;};var _linkIfExists=function(trialList){for(var i=0,length=trialList.length;i<length;i++){if(!trialList[i]){return"";}}
return trialList.join('-');};return{ENGINE_ACCOUNT:ENGINE_ACCOUNT,ENGINE_SAMPLING_RATIO:ENGINE_SAMPLING_RATIO,createEvent:function(eventName,extraOptions){return new EventObject(eventName,extraOptions);},setAttribute:function(aPage,aViewer,anOwner,aRelation,aService){page=aPage;viewer=aViewer;owner=anOwner;relation=aRelation;service=aService;},invoke:function(eventObject){}};})();(function(){if(location.pathname!="/show_friend.pl"){return;}
var elementList=document.getElementsByTagName('a');for(var i=0,length=elementList.length;i<length;i++){var anchor=elementList[i];if(anchor.href.match('/show_friend\.pl')&&!anchor.href.match(/#/)){var anchorText=anchor.innerHTML;anchor.href+="&_fof";anchor.innerHTML=anchorText;}}})();(function(){if(!Prototype){return;}
var dispatch=function(eventQuery,event){eventQuery.name.split(/,/).each(function(eventName){Mixi.Analysis.createEvent(eventName,eventQuery).fire();});};$$('form.JS_ANALYSIS_EVENT').each(function(element){var eventQuery=element.getAttribute('rel').parseQuery();element.observe('submit',function(event){dispatch(eventQuery,event);});});$$('a.JS_ANALYSIS_EVENT').each(function(element){var eventQuery=element.getAttribute('rel').parseQuery();element.observe('click',function(event){dispatch(eventQuery,event);});});})();Namespace('jp.mixi.analysis.widget.elementtracker')
.use('jp.co.mixi.dom.dataset.formatter format')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.use('jp.co.mixi.net.storage Storage')
.define(function(ns){'use strict';var isImpressionEventSent=false;function appendTracker(element,dataset){var formattedDataset=ns.format({trackingNamespace:'string',trackingResourceId:'string'},dataset);appendImpressionTracker(element,formattedDataset);appendClickTracker(element,formattedDataset);}
function appendImpressionTracker(element,dataset){var scrollCheckInterval=500;var $window=$j(window);var impressionTracker=_.throttle(function(){if($window.scrollTop()+$window.height()>=$j(element).offset().top){$window.off('load',impressionTracker);$window.off('scroll',impressionTracker);sendEvent('impression',dataset,function(){isImpressionEventSent=true;});}},scrollCheckInterval);$window.on('load',impressionTracker);$window.on('scroll',impressionTracker);}
function appendClickTracker(element,dataset){$j(element).one('click',function(e){var nextLocation=element.href;if(nextLocation)e.preventDefault();if(!isImpressionEventSent)sendEvent('impression',dataset);sendEvent('click',dataset,function(){if(nextLocation)location.href=nextLocation;});});}
function sendEvent(eventName,dataset,onComplete){var isFirstTrackingPer24h=true;if(ns.Storage.isAvailable()){var storageNamespace=ns.CURRENT_NAMESPACE;var storageKey=[dataset.trackingNamespace,dataset.trackingResourceId,eventName].join('-');var storageExpire=1000*60*60*24;var storageExpireDate=new Date(Date.now()+storageExpire);isFirstTrackingPer24h=ns.Storage.load(storageNamespace,storageKey)?false:true;ns.Storage.save(storageNamespace,storageKey,true,storageExpireDate);}
var timeout=500;ns.JSONRPC.createService('/system/rpc.json',{auth_type:'none'}).call('jp.mixi.analysis.elementtracker.element.track',{namespace:dataset.trackingNamespace,resource_id:dataset.trackingResourceId,event:eventName,is_first_tracking_per_24h:isFirstTrackingPer24h},(onComplete||function(){}),(onComplete||function(){}));if(onComplete){setTimeout(onComplete,timeout);}}
ns.provide({registerElement:appendTracker});});